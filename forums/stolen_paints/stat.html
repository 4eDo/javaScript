<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Сводная таблица</title>
    <style>
        table {
            border-collapse: collapse;
        }
        th, td {
            border: 1px solid black;
            padding: 8px;
            text-align: center;
        }
        th {
            background-color: rgba(0,0,0,0.3);
        }
        .w-70px {
            width: 70px;
        }
        tr:hover {
            background-color: rgba(0,0,0,0.3);
        }
        .color-box {
            width: 50px;
            background-repeat:no-repeat;
            background-position: center center;
        }
        .red-box {
          background-image: url("img/paint_0_red.png");
        }
        .green-box {
          background-image: url("img/paint_1_green.png");
        }
        .blue-box {
          background-image: url("img/paint_2_blue.png");
        }
        .white-box {
          background-image: url("img/paint_4_white.png");
        }
        .black-box {
          background-image: url("img/paint_3_black.png");;
        }
        .gray-box {
          background-image: url("img/paint_5_gray.png");
        }
        .rainbow-box {
          background-image: url("img/paint_6_rainbow.png");
        }
    </style>
</head>
<body>

<h1>Сводная таблица по пользователям и картинам</h1>
<table>
    <thead>
        <tr>
            <th rowspan="2">Пользователь</th>
            <th colspan="7">Картины</th>
            <th colspan="7">Цвета</th>
            <th rowspan="2">Итого</th>
        </tr>
        <tr>
            <th class="w-70px">Алый дракон</th>
            <th class="w-70px">Зелёный леший</th>
            <th class="w-70px">Сапфировая акула</th>
            <th class="w-70px">Живая тень</th>
            <th class="w-70px">Белоснежный пегас</th>
            <th class="w-70px">Скучающий дементор</th>
            <th class="w-70px">Пьяная вейла</th>
            <th class="color-box red-box" title="Красный пигмент"></th>
            <th class="color-box green-box" title="Зелёный пигмент"></th>
            <th class="color-box blue-box" title="Синий пигмент"></th>
            <th class="color-box black-box" title="Чёрный пигмент"></th>
            <th class="color-box white-box" title="Белый пигмент"></th>
            <th class="color-box gray-box" title="Выцветшая основа"></th>
            <th class="color-box rainbow-box" title="Психоделическая основа"></th>
        </tr>
    </thead>
    <tbody id="data-body">
        <!-- Здесь будет заполнение данных -->
    </tbody>
</table>

<script>
    const timestamp = new Date().getTime();
    const url = `https://4edo.github.io/javaScript/forums/stolen_paints/found_paints.json?timestamp=${timestamp}`;

    fetch(url)
        .then(response => response.json())
        .then(data => {
            const users = {};

            data.forEach(item => {
                const user = item.user;
                const picId = item.picId;
                
                // Инициализация пользователя, если он еще не создан
                if (!users[user]) {
                    users[user] = {
                        picSums: Array(8).fill(0), // Суммы по picId
                        colorSums: {
                            red: 0,
                            green: 0,
                            blue: 0,
                            black: 0,
                            white: 0,
                            pale: 0,
                            vivid: 0
                        }
                    };
                }

                // Обновление сумм для цветов
                users[user].colorSums.red += parseFloat(item.red) || 0;
                users[user].colorSums.green += parseFloat(item.green) || 0;
                users[user].colorSums.blue += parseFloat(item.blue) || 0;
                users[user].colorSums.black += parseFloat(item.black) || 0;
                users[user].colorSums.white += parseFloat(item.white) || 0;
                users[user].colorSums.pale += parseFloat(item.pale) || 0;
                users[user].colorSums.vivid += parseFloat(item.vivid) || 0;

                // Обновление сумм для картин
                const picIdIndex = parseInt(picId);
                if (picIdIndex > 0 && picIdIndex <= 7) {
                    const colorSum = 
                        parseFloat(item.red) + 
                        parseFloat(item.green) + 
                        parseFloat(item.blue) + 
                        parseFloat(item.black) + 
                        parseFloat(item.white) + 
                        parseFloat(item.pale) + 
                        parseFloat(item.vivid) || 0;
                    
                    users[user].picSums[picIdIndex] += colorSum;
                }
            });

            // Заполнение таблицы
            const tbody = document.getElementById('data-body');
            users = Object.keys(users).sort(function(a,b){return a>b;});
            for (const user in users) {
                const { picSums, colorSums } = users[user];
                const totalSum = Object.values(colorSums).reduce((a, b) => a + b, 0);
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${user}</td>
                    <td>${parseFloat(picSums[1].toFixed(2))}</td>
                    <td>${parseFloat(picSums[2].toFixed(2))}</td>
                    <td>${parseFloat(picSums[3].toFixed(2))}</td>
                    <td>${parseFloat(picSums[4].toFixed(2))}</td>
                    <td>${parseFloat(picSums[5].toFixed(2))}</td>
                    <td>${parseFloat(picSums[6].toFixed(2))}</td>
                    <td>${parseFloat(picSums[7].toFixed(2))}</td>
                    <td>${parseFloat(colorSums.red.toFixed(2))}</td>
                    <td>${parseFloat(colorSums.green.toFixed(2))}</td>
                    <td>${parseFloat(colorSums.blue.toFixed(2))}</td>
                    <td>${parseFloat(colorSums.black.toFixed(2))}</td>
                    <td>${parseFloat(colorSums.white.toFixed(2))}</td>
                    <td>${parseFloat(colorSums.pale.toFixed(2))}</td>
                    <td>${parseFloat(colorSums.vivid.toFixed(2))}</td>
                    <td>${parseFloat(totalSum.toFixed(2))}</td>
                `;
                tbody.appendChild(row);
            }
        })
        .catch(error => console.error('Ошибка загрузки данных:', error));

</script>
</body>
</html>
