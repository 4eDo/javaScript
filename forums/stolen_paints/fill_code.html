<!DOCTYPE html>
<html>
<head>
<title>Форма</title>
</head>
<body>

<p>User: <input type="text" id="uname" /></p>
<p>PicId: <input type="number" min="0" max="7" id="picId"/></p>
<p>Count: <input type="number" min="1" id="count" /></p>
<p>pigm: <input type="number" min="0" id="pigm"  step="0.5"/></p>
<p>selColor: <select id="color">
	<option value="none">none</option>
	<option value="red">red</option>
	<option value="green">green</option>
	<option value="blue">blue</option>
	<option value="black">black</option>
	<option value="white">white</option>
	<option value="pale">pale</option>
	<option value="vivid">vivid</option>
</select></p>
<p>Red: <input type="number"  id="red" step="0.5"/></p>
<p>Green: <input type="number"  id="green" step="0.5"/></p>
<p>Blue: <input type="number"  id="blue" step="0.5"/></p>
<p>Black: <input type="number"  id="black" step="0.5"/></p>
<p>White: <input type="number"  id="white" step="0.5"/></p>
<p>Pale: <input type="number"  id="pale" step="0.5"/></p>
<p>Vivid: <input type="number"  id="vivid" step="0.5"/></p>

<p><button id="getLinkBtn">Получить ссылку</button></p>
<p><button id="loadCodeBtn">Загрузить код</button></p>

<textarea id="outputText" width="300px" height="500px" readonly placeholder="Результат будет здесь..."></textarea>

<script>
  const getLinkBtn = document.getElementById('getLinkBtn');
  const loadCodeBtn = document.getElementById('loadCodeBtn');
  const outputText = document.getElementById('outputText');
  const fields = [
    'uname',
    'pigm',
    'color',
    'red',
    'green',
    'blue',
    'black',
    'white',
    'pale',
    'vivid',
  ];

  // Функция для получения значений из формы или URL-параметров
  function getValues(source = 'form') {
    const values = {};
    fields.forEach(field => {
      const element = document.getElementById(field);
      const value = source === 'form' ? element.value : new URLSearchParams(window.location.search).get(field) || 0;
      values[field] = value;
    });
    return values;
  }

  // Функция для заполнения формы значениями
  function setValues(values) {
    fields.forEach(field => {
      document.getElementById(field).value = values[field];
    });
  }

  // Функция для обработки значений полей
  function processValues(values) {
    if (!values.red && !values.green && !values.blue && !values.black && !values.white && !values.pale && !values.vivid && values.pigm) {
      if (values.color === "none") {
        const colors = ["red", "green", "blue", "black", "white", "pale", "vivid"];
        const randomColor = colors[Math.floor(Math.random() * colors.length)];
        values[randomColor] = values.pigm;
      } else {
        values[values.color] = values.pigm;
      }
    }
    return values;
  }

  // Функция для формирования JSON-объекта
  function createJson(values) {
    const count = parseFloat(document.getElementById('count').value) || 1; // Получаем count из формы
    const picId = document.getElementById('picId').value || 0;
    return `
    {
        "user": "${values.uname}",
        "picId": "${picId}",
        "red": "${parseFloat(values.red) * count}",
        "green": "${parseFloat(values.green) * count}",
        "blue": "${parseFloat(values.blue) * count}",
        "white": "${parseFloat(values.white) * count}",
        "black": "${parseFloat(values.black) * count}",
        "pale": "${parseFloat(values.pale) * count}",
        "vivid": "${parseFloat(values.vivid) * count}"
      },`;
  }

  // Загрузка формы из URL-параметров при загрузке страницы
  window.addEventListener('load', () => {
    const values = processValues(getValues('url'));
    setValues(values);
  });

  // Обработчик события для изменения поля "count"
  document.getElementById('count').addEventListener('change', () => {
    const values = processValues(getValues('form')); // Получаем значения из формы
    outputText.value = createJson(values); // Вызываем createJson для обновления outputText
  });
  // Обработчик события для изменения поля "picId"
  document.getElementById('picId').addEventListener('change', () => {
    const values = processValues(getValues('form')); // Получаем значения из формы
    outputText.value = createJson(values); // Вызываем createJson для обновления outputText
  });

  getLinkBtn.addEventListener('click', () => {
    const urlParams = new URLSearchParams(window.location.search);
    const values = processValues(getValues('form')); // Получаем значения из формы

    // Убираем count и picId из URL-параметров
    fields.forEach(field => {
      if (field !== 'count' && field !== 'picId' && values[field]) {
        urlParams.set(field, values[field]);
      }
    });

    const newUrl = `${window.location.origin}${window.location.pathname}?${urlParams.toString()}`;
    outputText.value = newUrl;
  });

  loadCodeBtn.addEventListener('click', () => {
    const values = processValues(getValues('form'));
    setValues(values);
    outputText.value = createJson(values);
  });
</script>
</body>
</html>
